AWSTemplateFormatVersion: '2010-09-09'
Description: SlideRule Test Runner Instance

Parameters:

  #
  # Variables
  #
  Domain:
    Type: String
  EnvironmentVersion:
    Type: String
  ProjectBucket:
    Type: String
  ProjectFolder:
    Type: String
  ContainerRegistry:
    Type: String
  DestroyLambdaArn:
    Type: String
  ScheduleLambdaArn:
    Type: String
  DeployDate:
    Type: String
  Branch:
    Type: String

  #
  # Constants
  #
  AvailabilityZone:
    Type: String
    Default: "us-west-2d"
  DeleteAfterMinutes:
    Type: Number
    Default: 80
  DockerComposeVersion:
    Type: String
    Default: "v2.24.5"

Resources:

  #
  # Network
  #
  RemoteVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: "10.0.0.0/16"
      EnableDnsSupport: true
      EnableDnsHostnames: true
  RemoteSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref RemoteVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Ref AvailabilityZone
  RemoteIGW:
    Type: AWS::EC2::InternetGateway
  AttachIGW:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref RemoteIGW
      VpcId: !Ref RemoteVPC
  RemoteRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref RemoteVPC
  RemoteRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachIGW
    Properties:
      RouteTableId: !Ref RemoteRouteTable
      DestinationCidrBlock: "0.0.0.0/0"
      GatewayId: !Ref RemoteIGW
  RouteAssoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref RemoteSubnet
      RouteTableId: !Ref RemoteRouteTable
  S3VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref RemoteVPC
      ServiceName: !Sub "com.amazonaws.${AWS::Region}.s3"
      VpcEndpointType: Gateway
      RouteTableIds:
        - !Ref RemoteRouteTable
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: "*"
            Action: "*"
            Resource: "*"
  #
  # IAM Role
  #
  RemoteRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/CloudWatchAgentAdminPolicy
      Policies:
        - PolicyName: testrunner-s3-access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action: ["s3:ListBucket"]
                Resource:
                  - arn:aws:s3:::sliderule
                  - arn:aws:s3:::sliderule-public
                  - arn:aws:s3:::pgc-opendata-dems
                  - arn:aws:s3:::prd-tnm
                  - arn:aws:s3:::esa-worldcover
                  - arn:aws:s3:::noaa-ocs-nationalbathymetry-pds
                  - arn:aws:s3:::dataforgood-fb-data
              - Effect: Allow
                Action: ["s3:GetObject"]
                Resource:
                  - arn:aws:s3:::sliderule/*
                  - arn:aws:s3:::sliderule-public/*
                  - arn:aws:s3:::pgc-opendata-dems/*
                  - arn:aws:s3:::prd-tnm/*
                  - arn:aws:s3:::esa-worldcover/*
                  - arn:aws:s3:::noaa-ocs-nationalbathymetry-pds/*
                  - arn:aws:s3:::dataforgood-fb-data/*
              - Effect: Allow
                Action: ["s3:PutObject"]
                Resource:
                  - !Sub "arn:aws:s3:::${ProjectBucket}/${ProjectFolder}/testrunner/*"
        - PolicyName: testrunner-ec2-access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - ec2:DescribeInstances
                  - ec2:TerminateInstances
                Resource: "*"
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref RemoteRole]

  #
  # Security Group
  #
  RemoteSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Test Runner Security Group
      VpcId: !Ref RemoteVPC
      SecurityGroupEgress:
        # ALL
        - IpProtocol: -1
          FromPort: 0
          ToPort: 0
          CidrIp: "0.0.0.0/0"
      Tags:
        - Key: Name
          Value: "testrunner-sg"

  #
  # EC2 Instance
  #
  TestRunnerInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-default-arm64}}'
      InstanceType: t4g.2xlarge
      AvailabilityZone: !Ref AvailabilityZone
      IamInstanceProfile: !Ref InstanceProfile
      SourceDestCheck: true
      Monitoring: false
      NetworkInterfaces:
        - DeviceIndex: 0
          AssociatePublicIpAddress: true
          SubnetId: !Ref RemoteSubnet
          GroupSet:
            - !Ref RemoteSG
      BlockDeviceMappings:
        - DeviceName: /dev/xvda
          Ebs:
            VolumeSize: 40
            VolumeType: gp3
            DeleteOnTermination: true
      Tags:
        - Key: Name
          Value: !Sub "testrunner-${DeployDate}"
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          export HOME=/root
          export USER=root
          export AWS_REGION=${AWS::Region}
          #
          # System Dependencies
          #
          dnf update -y
          dnf install -y git make rsync wget docker
          #
          # Configure Docker
          #
          systemctl enable docker
          systemctl start docker
          usermod -aG docker ec2-user
          aws ecr get-login-password --region ${AWS::Region} | docker login --username AWS --password-stdin ${ContainerRegistry}
          #
          # Install Docker Compose V2
          #
          curl -L "https://github.com/docker/compose/releases/download/${DockerComposeVersion}/docker-compose-linux-aarch64" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          mkdir -p /usr/local/lib/docker/cli-plugins
          ln -s /usr/local/bin/docker-compose /usr/local/lib/docker/cli-plugins/docker-compose
          #
          # ILB
          #
          mkdir -p /etc/ssl/private
          aws s3 cp s3://${ProjectBucket}/${ProjectFolder}/${Domain}.pem /etc/ssl/private/${Domain}.pem
          #
          # AMS
          #
          mkdir -p /data/ATL13
          aws s3 cp s3://${ProjectBucket}/${ProjectFolder}/atl13.json /data/ATL13/atl13.json
          aws s3 cp s3://${ProjectBucket}/${ProjectFolder}/atl13.db /data/ATL13/atl13.db
          mkdir -p /data/ATL24
          aws s3 cp s3://${ProjectBucket}/${ProjectFolder}/atl24r2.db /data/ATL24/atl24r2.db
          mkdir -p /data/3DEP
          aws s3 cp s3://${ProjectBucket}/${ProjectFolder}/3dep.db /data/3DEP/3dep.db
          #
          # Plugins
          #
          mkdir -p /plugins
          aws s3 cp s3://${ProjectBucket}/plugins/ /plugins/ --recursive
          #
          # Install Mamba
          #
          cd /
          wget https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-aarch64.sh
          bash Miniforge3-Linux-aarch64.sh -b
          #
          # Setup and Clone SlideRule Repository
          #
          docker pull ${ContainerRegistry}/sliderule-buildenv:latest
          git clone https://github.com/SlideRuleEarth/sliderule.git
          cd /sliderule
          git checkout ${Branch}
          #
          # Configure Logging
          #
          exec > /testrunner.log 2>&1
          #
          # Build and Run Self Tests
          #
          cd /sliderule/targets/slideruleearth
          make build CONFIG=debug BUILD_CMD="sh -c \"cd /sliderule/targets/slideruleearth && make config-debug && make && make selftest\""
          #
          # Build Cluster
          #
          make cluster-docker
          #
          # SlideRule PyTests
          #
          cd /sliderule/targets/slideruleearth
          docker compose up -d ilb ams sliderule
          cd /sliderule/clients/python
          /root/miniforge3/bin/mamba env create -f environment.yml -y
          /root/miniforge3/envs/sliderule/bin/pip install .
          /root/miniforge3/envs/sliderule/bin/pytest --domain localhost --organization None
          cd /sliderule/targets/slideruleearth
          docker compose down ilb ams sliderule
          #
          # Provisioner PyTests
          #
          cd /sliderule/applications/provisioner
          /root/miniforge3/bin/mamba env create -f environment.yml -y
          /root/miniforge3/envs/provisioner/bin/pytest
          #
          # AMS PyTests
          #
          cd /sliderule/applications/ams
          /root/miniforge3/bin/mamba env create -f environment.yml -y
          /root/miniforge3/envs/ams/bin/pytest
          #
          # Record of Run
          #
          aws s3 cp /testrunner.log s3://${ProjectBucket}/${ProjectFolder}/testrunner/${Branch}-${DeployDate}-testrunner.log
          cd /sliderule/applications/provisioner
          /root/miniforge3/envs/provisioner/bin/python utils/testrunner_report.py --testfile ${Branch}-${DeployDate}-testrunner.log --testdir s3://${ProjectBucket}/${ProjectFolder}/testrunner --branch ${Branch} --output /tmp/${Branch}-summary.json
          aws s3 cp /tmp/${Branch}-summary.json s3://${ProjectBucket}/${ProjectFolder}/testrunner/${Branch}-summary.json

  #
  # Custom Schedule Trigger
  #
  AutoDeleteScheduler:
    Type: Custom::ScheduleStackDeletion
    DependsOn:
      - TestRunnerInstance
    Properties:
      ServiceToken: !Ref ScheduleLambdaArn
      StackName: !Ref AWS::StackName
      DeleteAfterMinutes: !Ref DeleteAfterMinutes
      DeletionLambdaArn: !Ref DestroyLambdaArn
